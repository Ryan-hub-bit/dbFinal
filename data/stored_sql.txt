DROP PROCEDURE SearchByTitle;
DROP PROCEDURE SearchByID;
DROP PROCEDURE SearchByKeyword;
DROP PROCEDURE AddFavorite;
DROP PROCEDURE RmvFavorite;


DELIMITER //
CREATE PROCEDURE SearchByTitle(IN input VARCHAR(20))
BEGIN
SELECT * FROM db.mDetail WHERE title LIKE '%input%' ORDER BY title ASC;
END; //


DELIMITER //
CREATE PROCEDURE SearchByID(IN input INT)
BEGIN
SELECT * FROM db.mDetail WHERE movie_id = input;
END; //


DELIMITER //
CREATE PROCEDURE SearchByGeneral(IN keyword VARCHAR(50), IN adlt VARCHAR(5), IN runtime INT, IN return INT)
BEGIN
CREATE VIEW Filter AS (SELECT * FROM db.mDetail AS D, db.mType AS T WHERE D.movie_id = T.movie_id AND (D.title LIKE '%keyword%' OR D.tagline LIKE '%keyword%' OR D.genre LIKE '%keyword%') AND T.adult = adult AND T.runtime <= runtime)

SELECT COUNT(*) FROM Filter

CASE
WHEN return = 1 THEN (SELECT title, genre, tagline FROM Filter)
WHEN return = 2 THEN (SELECT F.title, E.budget, E.revenue FROM Filter AS F, db.mEcoBen AS E WHERE F.movie_id = E.movie_id)
WHEN return = 3 THEN (SELECT F.title, R.popularity, R.vote_average FROM  Filter AS F, db.mRating AS R WHERE F.movie_id = R.movie_id)

DROP VIEW Filter

END; //


DELIMITER //
CREATE PROCEDURE AddFavorite(IN userID INT, IN movieID INT)
BEGIN
INSERT INTO db.watchedMovies(user_id,watched_movie_id) VALUES(userID, movieID);
END; //


DELIMITER //
CREATE PROCEDURE RmvFavorite(IN userID INT, IN movieID INT)
BEGIN
DELETE FROM db.watchedMovies WHERE user_id = userID AND movie_id = movieID;
END; //